{% extends "base_generic.html" %}

{% block include_header %}

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

{% endblock%}


{% block content %}
    <p id="coord">Your coordinates: </p>
    <button onclick="getLocation()">Locate Me</button>
    <br><br>

    <form method = "POST" action = "{% url 'main:getUserLocation' %}">
        {% csrf_token %}
            <label>Current State :</label><br>
        {% if location %}
            {{ location }}<br>
        {% else %}
            <input type="text" id="location" name= "location" value=""><br>
            <br>
            <input type = "submit" value = "Go"><br>
        {% endif %}
    </form>

    <br><br>
    {% if location %}
        <button onclick="location.href='{% url 'main:notifications' location|lower %}'"> Check Notifications </button>
    {% endif %}

    <!-- the drop down menu to take disaster name as input  -->
      <div id="disaster_wise_names">
        <label for="disaster_names">Disaster Name: </label><br>
        <select id="disaster_names" onchange="changeMapInfo()" name="disaster_names">
          <option value = "all_disasters"> All</option>
          {% for data in data %}
            <option value = "{{data}}"> {{data}}</option>
          {% endfor %}
        </select>
        <br><br>

      </div>

    <div style="height:800px;width:700px;" id="mapid"></div>

    <script>
      var x = document.getElementById("coord");
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
        } else {
          x.innerHTML = "Geolocation is not supported by this browser.";
        }
      }

      function showPosition(position) {
          console.log("y");
        x.innerHTML = "Latitude: " + position.coords.latitude +
        "<br>Longitude: " + position.coords.longitude;
        let lat = position.coords.latitude;
        let long = position.coords.longitude;
        // $("input[name='lat']").val(lat);
        // $("input[name='lat']").val(long);
        // let url_str = 'https://maps.googleapis.com/maps/api/geocode/json?latlng='+lat+','+long+'&key=AIzaSyB8sd6nmQXMsXjEoEHWIT1xX3iH2tR81wg'
        // $.getJSON(url_str, function(data) {
        //     console.log(data);
        //     //here you get the location data, like street address, city and pass it to inputs and submit the form to save it.
        // });

        $.get('https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat='+lat+'&lon='+long , function(data){
            console.log(data.address.road);
        });
      }

        center = [0, 0];
        center =[21.853283,81.079102];
        // center =[51.505, -0.09];

        //create the map
        // var mymap = L.map('mapid').setView(center, 0);

        // var map = L.map('map').setView(center, 0);

        var disaster_data ={} ;
        {% for disaster_key,disaster_values in data.items %}
          disaster_data.{{disaster_values.id}} = {};
          disaster_data.{{disaster_values.id}}.name = "{{disaster_values.name}}";
          disaster_data.{{disaster_values.id}}.coordinates={}
          disaster_data.{{disaster_values.id}}.coordinates.latitude = "{{disaster_values.coordinates.latitude}}";
          disaster_data.{{disaster_values.id}}.coordinates.longitude = "{{disaster_values.coordinates.longitude}}";
          disaster_data.{{disaster_values.id}}.coordinates.radius = {{disaster_values.coordinates.radius}};
          disaster_data.{{disaster_values.id}}.id = "{{disaster_values.id}}";
          disaster_data.{{disaster_values.id}}.scale = {{disaster_values.scale}};
          disaster_data.{{disaster_values.id}}.statistics = {};
          disaster_data.{{disaster_values.id}}.statistics.total = {};
          disaster_data.{{disaster_values.id}}.statistics.total.affected = {{disaster_values.statistics.total.affected}};
          disaster_data.{{disaster_values.id}}.statistics.total.deaths = {{disaster_values.statistics.total.deaths}};
        {% endfor %}

        var mymap = L.map('mapid').setView( center, 5);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
          attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
          maxZoom: 100,
          id: 'mapbox/streets-v11',
          tileSize: 512,
          zoomOffset: -1,
          accessToken: 'pk.eyJ1IjoibW5rMzQzIiwiYSI6ImNrODY0Z3F2NDBhcW8zZ284Yjg3Z3Q2ZWoifQ.XR8nBDHgRGjJq6nOg0rZAQ'
        }).addTo(mymap);

        var colors = ["#FA8072" , "#CD5C5C" , "#BA4545" , "#ED2939" , "#CA3433",
                      "#B22222", "#960018" , "#7CDAD2" , "#5E1914" , "#420D09"];
        for (let [disaster_key, disaster_values] of Object.entries(disaster_data)) {
          console.log(disaster_values.name);
          console.log(disaster_values.coordinates.latitude);
          console.log(disaster_values.coordinates.longitude);
          console.log(disaster_values.scale);
          console.log(disaster_values.coordinates.radius);
          center = [  disaster_values.coordinates.latitude  ,  disaster_values.coordinates.longitude  ]
          console.log(center);
          eval( 'var circle_' + disaster_values.id + '= ' +
          ' L.circle(center, {' +
          '  color: colors[' + disaster_values.scale +'-1 ],' +
          '  fillColor: colors['+ disaster_values.scale +'-1 ],' +
          ' fillOpacity: 0.7,' +
          '  radius: '+disaster_values.coordinates.radius+
          '}).addTo(mymap);');
          eval('circle_' + disaster_values.id + '.bindPopup( "<b>'+disaster_values.name+'</b><br><b>Scale:</b>'+ disaster_values.scale+'<br><b>Total Affected: </b>'+disaster_values.statistics.total.affected+ '<br><b>Total Deaths: </b>'+disaster_values.statistics.total.deaths+'<br>" );');
          }

        // console.log(disaster_data);

        function changeMapInfo()
        {
          center =[21.853283,81.079102];
          var disaster_name = document.getElementById("disaster_names").value;
          console.log(disaster_name);
          mymap.remove();
          mymap = L.map('mapid').setView( center, 5);

          L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 100,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoibW5rMzQzIiwiYSI6ImNrODY0Z3F2NDBhcW8zZ284Yjg3Z3Q2ZWoifQ.XR8nBDHgRGjJq6nOg0rZAQ'
          }).addTo(mymap);

          var colors = ["#FA8072" , "#CD5C5C" , "#BA4545" , "#ED2939" , "#CA3433",
                        "#B22222", "#960018" , "#7CDAD2" , "#5E1914" , "#420D09"];
          for (let [disaster_key, disaster_values] of Object.entries(disaster_data)) {
              if( disaster_name == "all_disasters" || ( disaster_name!="all_disasters" && disaster_name == disaster_values.name  )  )
              {
                center = [  disaster_values.coordinates.latitude  ,  disaster_values.coordinates.longitude  ]
                console.log(center);
                eval( 'var circle_' + disaster_values.id + '= ' +
                ' L.circle(center, {' +
                '  color: colors[' + disaster_values.scale +'-1 ],' +
                '  fillColor: colors['+ disaster_values.scale +'-1 ],' +
                ' fillOpacity: 0.7,' +
                '  radius: '+disaster_values.coordinates.radius+
                '}).addTo(mymap);');
                eval('circle_' + disaster_values.id + '.bindPopup( "<b>'+disaster_values.name+'</b><br><b>Scale:</b>'+ disaster_values.scale+'<br><b>Total Affected: </b>'+disaster_values.statistics.total.affected+ '<br><b>Total Deaths: </b>'+disaster_values.statistics.total.deaths+'<br>" );');
              }
          }
        };
        // var circle1 = L.circle([51.519, -0.11], {
        //   color: 'red',
        //   fillColor: '#f03',
        //   fillOpacity: 0.5,
        //   radius: 500
        // }).addTo(mymap);
        //
        // circle1.bindPopup("I am a circle.");
        //
        // function onMapClick(e) {
        //   alert("You clicked the map at " + e.latlng);
        // }
        //
        // mymap.on('click', onMapClick);

    </script>


{% endblock %}

{% block css %}
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
{% endblock %}

{% extends "base_generic.html" %}

{% block include_header %}

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

{% endblock%}


{% block content %}
    <p id="coord">Your coordinates: </p>
    <button onclick="getLocation()">Locate Me</button>
    <br><br>

    <form method = "POST" action = "{% url 'main:getUserLocation' %}">
        {% csrf_token %}
            <label>Current State :</label><br>
        {% if location %}
            {{ location }}<br>
        {% else %}
            <input type="text" id="location" name= "location" value=""><br>
            <br>
            <input type = "submit" value = "Go"><br>
        {% endif %}
    </form>

    <br><br>
    {% if location %}
        <button onclick="location.href='{% url 'main:notifications' location|lower %}'"> Check Notifications </button>
    {% endif %}



    <div style="height:800px;width:700px;" id="mapid"></div>

    <script>
      var x = document.getElementById("coord");
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
        } else {
          x.innerHTML = "Geolocation is not supported by this browser.";
        }
      }

      function showPosition(position) {
          console.log("y");
        x.innerHTML = "Latitude: " + position.coords.latitude +
        "<br>Longitude: " + position.coords.longitude;
        let lat = position.coords.latitude;
        let long = position.coords.longitude;
        // $("input[name='lat']").val(lat);
        // $("input[name='lat']").val(long);
        // let url_str = 'https://maps.googleapis.com/maps/api/geocode/json?latlng='+lat+','+long+'&key=AIzaSyB8sd6nmQXMsXjEoEHWIT1xX3iH2tR81wg'
        // $.getJSON(url_str, function(data) {
        //     console.log(data);
        //     //here you get the location data, like street address, city and pass it to inputs and submit the form to save it.
        // });

        $.get('https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat='+lat+'&lon='+long , function(data){
            console.log(data.address.road);
        });
      }

        center = [0, 0];
        center =[21.730671,79.6728];
        center =[21.853283,81.079102];
        // center =[51.505, -0.09];

        //create the map
        var mymap = L.map('mapid').setView( center, 5);
        // var mymap = L.map('mapid').setView(center, 0);

        // var map = L.map('map').setView(center, 0);

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
          attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
          maxZoom: 100,
          id: 'mapbox/streets-v11',
          tileSize: 512,
          zoomOffset: -1,
          accessToken: 'pk.eyJ1IjoibW5rMzQzIiwiYSI6ImNrODY0Z3F2NDBhcW8zZ284Yjg3Z3Q2ZWoifQ.XR8nBDHgRGjJq6nOg0rZAQ'
        }).addTo(mymap);
        // var circle = L.circle(center, {
        //   color: 'red',
        //   fillColor: '#f03',
        //   fillOpacity: 0.5,
        //   radius: 90000
        // }).addTo(mymap);
        // circle.bindPopup("I am a circle.");

        var colors = ["#FA8072" , "#CD5C5C" , "#BA4545" , "#ED2939" , "#CA3433",
                      "#B22222", "#960018" , "#7CDAD2" , "#5E1914" , "#420D09"];

        {% for dictionary in data %}

            center = [ {{dictionary.coordinates.latitude}} , {{ dictionary.coordinates.longitude }} ]
            var circle_{{dictionary.id}} = L.circle(center, {
              color: colors[ {{dictionary.scale}} -1 ],
              fillColor: colors[ {{dictionary.scale}} -1 ],
              fillOpacity: 0.7,
              radius: {{dictionary.coordinates.radius }}
            }).addTo(mymap);
            circle_{{dictionary.id}}.bindPopup
            ( "<b>{{dictionary.name}}</b><br>"+
              "<b>Scale:</b> {{dictionary.scale}}<br>"+
              "<b>Total Affected: </b>{{dictionary.statistics.total.affected}}<br>"+
              "<b>Total Deaths: </b>{{dictionary.statistics.total.deaths}}<br>" );

        {% endfor %}


        // var circle1 = L.circle([51.519, -0.11], {
        //   color: 'red',
        //   fillColor: '#f03',
        //   fillOpacity: 0.5,
        //   radius: 500
        // }).addTo(mymap);
        //
        // circle1.bindPopup("I am a circle.");
        //
        // function onMapClick(e) {
        //   alert("You clicked the map at " + e.latlng);
        // }
        //
        // mymap.on('click', onMapClick);

    </script>


{% endblock %}

{% block css %}
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
{% endblock %}
